const $backLinkOrHome = $('.das-js-back-link');
const backLinkOrHome = function () {
    const backLink = $('<a>')
        .attr({ 'href': '#', 'class': 'govuk-back-link' })
        .text('Back')
        .on('click', function (e) {
            window.history.back();
            e.preventDefault();
        });

    $backLinkOrHome.replaceWith(backLink);
}

if ($backLinkOrHome) {
    backLinkOrHome();
}


function AutoComplete(selectField) {
    this.selectElement = selectField
}

AutoComplete.prototype.init = function () {
    this.autoComplete()
}

AutoComplete.prototype.getSuggestions = function (query, updateResults) {
    let results = [];
    let apiUrl = "/registeredProviders?query=" + query
    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            let jsonResponse = JSON.parse(xhr.responseText);
            results = jsonResponse.map(function (result) {
                return result
            });
            updateResults(results);
        }
    }
    xhr.open("GET", apiUrl, true);
    xhr.send();
}


AutoComplete.prototype.onConfirm = function (option) {
    // Populate form fields with selected option
    document.getElementById("LegalName").value = option.legalName;
    document.getElementById("Ukprn").value = option.ukprn;
}

function inputValueTemplate(result) {
<<<<<<< HEAD
    return result && [result.legalName, result.ukprn].filter(Boolean).join(' UKPRN: ')
}

function suggestionTemplate(result) {
    return result && [result.legalName, result.ukprn].filter(Boolean).join(' UKPRN: ')
=======
    return result && [result.legalName, result.ukprn].filter(element => element).join(' UKPRN: ')
}

function suggestionTemplate(result) {
    return result && [result.legalName, result.ukprn].filter(element => element).join(' UKPRN: ')
>>>>>>> CSP-2207 Search for training provider
}

AutoComplete.prototype.autoComplete = function () {
    let that = this
    accessibleAutocomplete.enhanceSelectElement({
        selectElement: that.selectElement,
        minLength: 2,
        autoselect: false,
        defaultValue: '',
        displayMenu: 'overlay',
        placeholder: '',
        source: that.getSuggestions,
        showAllValues: false,
        confirmOnBlur: false,
        onConfirm: that.onConfirm,
        templates: {
            inputValue: inputValueTemplate,
            suggestion: suggestionTemplate
        }
    });
}

function nodeListForEach(nodes, callback) {
<<<<<<< HEAD
    if (globalThis.NodeList.prototype.forEach) {
        return nodes.forEach(callback)
    }
    for (let i = 0; i < nodes.length; i++) {
        callback.call(globalThis, nodes[i], i, nodes);
=======
    if (window.NodeList.prototype.forEach) {
        return nodes.forEach(callback)
    }
    for (let i = 0; i < nodes.length; i++) {
        callback.call(window, nodes[i], i, nodes);
>>>>>>> CSP-2207 Search for training provider
    }
}

let autoCompletes = document.querySelectorAll('[data-module="autoComplete"]')

nodeListForEach(autoCompletes, function (autoComplete) {
    new AutoComplete(autoComplete).init()
})
